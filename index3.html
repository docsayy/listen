<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Listenify</title>
  <style>
    :root{
      --bg:#ffffff;
      --panel:#f6f7fb;
      --panel2:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#2563eb;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius:18px;
      --tap:44px;
    }
    [data-theme="dark"]{
      --bg:#0b1020;
      --panel:#0f1730;
      --panel2:#0c1328;
      --text:#e5e7eb;
      --muted:#a1a1aa;
      --border:#223053;
      --accent:#60a5fa;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 16px 14px 140px; /* room for player */
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 6px 2px 16px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:800;
      letter-spacing:.2px;
      font-size: 20px;
    }
    .logo{
      width:34px;height:34px;border-radius:12px;
      display:grid;place-items:center;
      background: linear-gradient(135deg, var(--accent), rgba(255,255,255,.0));
      border:1px solid rgba(255,255,255,.08);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .logo svg{width:22px;height:22px}

    .iconbar{
      display:flex; gap:10px; align-items:center;
    }
    .iconbtn{
      width: var(--tap);
      height: var(--tap);
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--panel2);
      color: var(--text);
      display:grid;
      place-items:center;
      box-shadow: 0 6px 18px rgba(0,0,0,.05);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .iconbtn:active{transform: scale(.98)}
    .iconbtn svg{width:20px;height:20px;opacity:.95}

    .hint{
      color: var(--muted);
      font-size: 13px;
      margin-top: 2px;
    }

    /* Player (fixed bottom) */
    .player{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: color-mix(in oklab, var(--panel) 88%, transparent);
      backdrop-filter: blur(10px);
      border-top: 1px solid var(--border);
      z-index: 50;
    }
    .player-inner{
      max-width: 980px;
      margin: 0 auto;
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
      display:flex;
      flex-direction: column;
      gap:10px;
    }
    .now{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .title{
      font-weight: 800;
      font-size: 16px;
      line-height: 1.2;
      margin:0;
      max-width: 72ch;
    }
    .subtitle{
      margin: 4px 0 0;
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap:8px;
      flex-wrap: wrap;
    }
    .chip{
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--muted);
    }

    .controls{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items:center;
    }

    .btnrow{
      display:flex; gap:10px; align-items:center; flex-wrap: wrap;
    }
    .pbtn{
      min-width: var(--tap);
      height: var(--tap);
      border-radius: 16px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      display:grid;
      place-items:center;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .pbtn.wide{
      padding: 0 12px;
      min-width: unset;
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      font-weight: 700;
      font-size: 13px;
    }
    .pbtn:active{transform: scale(.98)}
    .pbtn svg{width:20px;height:20px}

    .righttools{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap: wrap;
    }

    .range{
      width:100%;
    }
    input[type="range"]{
      width:100%;
      height: 34px;
      background: transparent;
      margin: 0;
    }
    .timebar{
      display:flex;
      justify-content:space-between;
      color: var(--muted);
      font-size: 12px;
      margin-top: -6px;
    }

    /* Drawer (list overlay) */
    .drawer-backdrop{
      position: fixed; inset:0;
      background: rgba(0,0,0,.45);
      display:none;
      z-index: 80;
    }
    .drawer{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 0;
      width: min(980px, 100%);
      max-height: 78vh;
      background: var(--bg);
      border-top-left-radius: 22px;
      border-top-right-radius: 22px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      display:none;
      z-index: 90;
      overflow: hidden;
    }
    .drawer-head{
      padding: 12px 12px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background: var(--panel2);
      border-bottom: 1px solid var(--border);
    }
    .drawer-title{
      font-weight: 900;
      font-size: 14px;
    }
    .drawer-body{
      padding: 12px;
      display:flex;
      flex-direction: column;
      gap: 10px;
      height: calc(78vh - 64px);
    }
    .searchrow{
      display:flex;
      gap: 10px;
      align-items:center;
    }
    .search{
      flex:1;
      height: 38px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      padding: 0 10px;
      font-size: 13px;
      outline: none;
    }
    .list{
      overflow:auto;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: var(--panel2);
    }
    .rowitem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .rowitem:last-child{border-bottom:none}
    .rowitem:active{background: color-mix(in oklab, var(--panel) 70%, transparent)}
    .rowtext{
      min-width: 0;
      display:flex;
      flex-direction: column;
      gap: 2px;
    }
    .rowtitle{
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .rowmeta{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .badge{
      font-size: 12px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--muted);
      flex:0 0 auto;
    }

    /* About modal */
    .modal-backdrop{
      position: fixed; inset:0;
      background: rgba(0,0,0,.45);
      display:none;
      z-index: 120;
    }
    .modal{
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%,-50%);
      width: min(520px, calc(100% - 24px));
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 22px;
      box-shadow: var(--shadow);
      display:none;
      z-index: 130;
      overflow:hidden;
    }
    .modal-head{
      padding: 12px 12px 10px;
      background: var(--panel2);
      border-bottom: 1px solid var(--border);
      display:flex; justify-content:space-between; align-items:center;
      gap: 10px;
    }
    .modal-title{font-weight:900; font-size: 14px;}
    .modal-body{
      padding: 12px;
      color: var(--text);
      font-size: 13px;
      line-height: 1.45;
    }
    .modal-body p{margin: 0 0 10px}
    .modal-body .muted{color: var(--muted)}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <div class="brand">
          <div class="logo" aria-hidden="true">
            <!-- simple play icon -->
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M9 7.5v9l8-4.5-8-4.5z" fill="currentColor" opacity=".95"/>
            </svg>
          </div>
          Listenify
        </div>
        <div class="hint">Tap the list icon in the player to browse episodes.</div>
      </div>

      <!-- Icon-only theme toggle (text removed) -->
      <div class="iconbar">
        <button class="iconbtn" id="themeBtn" title="Theme" aria-label="Theme">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M12 3a1 1 0 0 1 1 1v2a1 1 0 1 1-2 0V4a1 1 0 0 1 1-1Zm0 16a1 1 0 0 1 1 1v2a1 1 0 1 1-2 0v-2a1 1 0 0 1 1-1Zm9-7a1 1 0 0 1-1 1h-2a1 1 0 1 1 0-2h2a1 1 0 0 1 1 1ZM6 12a1 1 0 0 1-1 1H3a1 1 0 1 1 0-2h2a1 1 0 0 1 1 1Zm12.364-6.364a1 1 0 0 1 0 1.414l-1.414 1.414a1 1 0 1 1-1.414-1.414l1.414-1.414a1 1 0 0 1 1.414 0ZM7.464 16.536a1 1 0 0 1 0 1.414L6.05 19.364a1 1 0 1 1-1.414-1.414l1.414-1.414a1 1 0 0 1 1.414 0Zm12.9 2.828a1 1 0 0 1-1.414 0l-1.414-1.414a1 1 0 1 1 1.414-1.414l1.414 1.414a1 1 0 0 1 0 1.414ZM6.05 4.636a1 1 0 0 1 1.414 0L8.88 6.05A1 1 0 1 1 7.464 7.464L6.05 6.05a1 1 0 0 1 0-1.414Z" fill="currentColor" opacity=".85"/>
            <path d="M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8Z" fill="currentColor"/>
          </svg>
        </button>

        <!-- About button (theme-consistent) -->
        <button class="iconbtn" id="aboutBtn" title="About" aria-label="About">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20Z" stroke="currentColor" stroke-width="2" opacity=".9"/>
            <path d="M12 10.5v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M12 7.5h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
    </header>

    <main>
      <div class="hint">
        This page is intentionally simple — the episode list lives in the player.
      </div>
    </main>
  </div>

  <!-- Player -->
  <section class="player" aria-label="Audio player">
    <div class="player-inner">
      <div class="now">
        <div style="min-width:0">
          <!-- Title: "epi + title" ONLY -->
          <p class="title" id="nowTitle">No episode selected</p>
          <div class="subtitle">
            <span class="chip" id="nowTag">Ready</span>
            <span class="chip" id="nowSpeedChip">1×</span>
          </div>
        </div>

        <!-- List button moved into player section; icon-only -->
        <div class="righttools">
          <button class="pbtn" id="listBtn" title="List" aria-label="List">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
      </div>

      <div>
        <input class="range" id="seek" type="range" min="0" max="1000" value="0" />
        <div class="timebar">
          <span id="tCur">0:00</span>
          <span id="tDur">0:00</span>
        </div>
      </div>

      <div class="controls">
        <div class="btnrow">
          <button class="pbtn" id="back15" title="Back 15s" aria-label="Back 15 seconds">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M8 12a6 6 0 1 0 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M8 6v4h4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M13.2 9.2h1.4v5.6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M16.8 12.4c.8-.4 1.8 0 1.8 1s-1 1.4-1.8 1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>

          <button class="pbtn" id="playBtn" title="Play/Pause" aria-label="Play or pause">
            <svg id="playIcon" viewBox="0 0 24 24" fill="none">
              <path d="M9 7.5v9l8-4.5-8-4.5z" fill="currentColor"/>
            </svg>
          </button>

          <button class="pbtn" id="fwd30" title="Forward 30s" aria-label="Forward 30 seconds">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M16 12a6 6 0 1 1-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M16 6v4h-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M9.4 9.2h1.4v5.6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M13 10.4c.8-.4 1.8 0 1.8 1s-1 1.4-1.8 1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>

        <!-- Speed controls: one cycles, one resets -->
        <div class="righttools">
          <button class="pbtn wide" id="speedBtn" title="Speed" aria-label="Speed">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M12 21a9 9 0 1 0-9-9" stroke="currentColor" stroke-width="2" opacity=".9"/>
              <path d="M12 12l4-2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M4 12h3" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity=".7"/>
            </svg>
            <span id="speedLabel">1×</span>
          </button>

          <button class="pbtn" id="speedResetBtn" title="Reset speed" aria-label="Reset speed">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M3 12a9 9 0 1 0 3-6.7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M3 5v4h4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
      </div>

      <audio id="audio" preload="metadata"></audio>
    </div>
  </section>

  <!-- Drawer -->
  <div class="drawer-backdrop" id="drawerBackdrop"></div>
  <section class="drawer" id="drawer" aria-label="Episode list">
    <div class="drawer-head">
      <div class="drawer-title">Episodes</div>
      <button class="iconbtn" id="drawerClose" title="Close" aria-label="Close">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
    <div class="drawer-body">
      <div class="searchrow">
        <!-- Search should NOT auto-open keyboard; no autofocus -->
        <input class="search" id="search" placeholder="Search episodes…" />
        <button class="pbtn" id="clearSearch" title="Clear" aria-label="Clear search">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <div class="list" id="episodeList"></div>
    </div>
  </section>

  <!-- About modal -->
  <div class="modal-backdrop" id="aboutBackdrop"></div>
  <section class="modal" id="aboutModal" role="dialog" aria-modal="true" aria-label="About Listenify">
    <div class="modal-head">
      <div class="modal-title">About Listenify</div>
      <button class="iconbtn" id="aboutClose" title="Close" aria-label="Close">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <p><strong>What is this?</strong><br/>A lightweight, distraction-free audio player for your curated study/playlists.</p>
      <p><strong>Who made it?</strong><br/>Built by you (and a helpful robot assistant) as a fast, simple player you can host anywhere.</p>
      <p><strong>Why?</strong><br/>So you can hit play and keep learning without fighting cluttery apps.</p>
      <p class="muted">Tip: the list button lives in the player; speed controls are next to it.</p>
    </div>
  </section>

  <script>
    // ---------- Config ----------
    // Expecting JSON at: episodes.json
    // Format supported (flexible):
    // [
    //  { "id":"epi01", "title":"Brain tumors - intro", "src":"./assets/audio/epi01.mp3", "system":"Neuro", "tags":["Step3"] },
    //  ...
    // ]
    const EP_URL = "episodes.json";

    // Speed cycle: 1.25×, 1.5×, 1.75×, 2×, 2.5× + reset to 1× via separate button
    const SPEEDS = [1, 1.25, 1.5, 1.75, 2, 2.5];

    // ---------- State ----------
    const els = {
      themeBtn: document.getElementById("themeBtn"),
      aboutBtn: document.getElementById("aboutBtn"),
      aboutBackdrop: document.getElementById("aboutBackdrop"),
      aboutModal: document.getElementById("aboutModal"),
      aboutClose: document.getElementById("aboutClose"),

      listBtn: document.getElementById("listBtn"),
      drawerBackdrop: document.getElementById("drawerBackdrop"),
      drawer: document.getElementById("drawer"),
      drawerClose: document.getElementById("drawerClose"),
      episodeList: document.getElementById("episodeList"),
      search: document.getElementById("search"),
      clearSearch: document.getElementById("clearSearch"),

      audio: document.getElementById("audio"),
      playBtn: document.getElementById("playBtn"),
      playIcon: document.getElementById("playIcon"),
      back15: document.getElementById("back15"),
      fwd30: document.getElementById("fwd30"),
      seek: document.getElementById("seek"),
      tCur: document.getElementById("tCur"),
      tDur: document.getElementById("tDur"),

      nowTitle: document.getElementById("nowTitle"),
      nowTag: document.getElementById("nowTag"),

      speedBtn: document.getElementById("speedBtn"),
      speedResetBtn: document.getElementById("speedResetBtn"),
      speedLabel: document.getElementById("speedLabel"),
      nowSpeedChip: document.getElementById("nowSpeedChip"),
    };

    let episodes = [];
    let currentId = null;
    let seeking = false;

    // ---------- Helpers ----------
    const LS = {
      theme: "listenify_theme",
      lastId: "listenify_last_id",
      lastTime: "listenify_last_time",
      speed: "listenify_speed",
    };

    function fmtTime(sec){
      if (!isFinite(sec) || sec < 0) sec = 0;
      sec = Math.floor(sec);
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${m}:${String(s).padStart(2,"0")}`;
    }

    function safeTitle(ep){
      // Requirement: show "epi + title" only; remove system/extra stuff.
      // We'll build: "epi <id> — <title>" if id exists, else "epi — <title>"
      const idPart = ep?.id ? String(ep.id).replace(/[_-]+/g," ").trim() : "";
      const t = (ep?.title ?? "Untitled").toString().trim();

      // If title already starts with "epi" we won't double it.
      const lower = t.toLowerCase();
      if (lower.startsWith("epi ")) return t;

      if (idPart) return `epi ${idPart} — ${t}`;
      return `epi — ${t}`;
    }

    function setTheme(theme){
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem(LS.theme, theme);
    }

    function getTheme(){
      return localStorage.getItem(LS.theme) || "light";
    }

    function openDrawer(){
      els.drawerBackdrop.style.display = "block";
      els.drawer.style.display = "block";
      // Do NOT autofocus search (prevents keyboard popping).
    }
    function closeDrawer(){
      els.drawerBackdrop.style.display = "none";
      els.drawer.style.display = "none";
    }

    function openAbout(){
      els.aboutBackdrop.style.display = "block";
      els.aboutModal.style.display = "block";
    }
    function closeAbout(){
      els.aboutBackdrop.style.display = "none";
      els.aboutModal.style.display = "none";
    }

    function setSpeed(rate){
      els.audio.playbackRate = rate;
      localStorage.setItem(LS.speed, String(rate));
      const label = rate === 1 ? "1×" : `${rate}×`;
      els.speedLabel.textContent = label;
      els.nowSpeedChip.textContent = label;
    }

    function loadSavedSpeed(){
      const raw = localStorage.getItem(LS.speed);
      const v = raw ? Number(raw) : 1;
      const rate = SPEEDS.includes(v) ? v : 1;
      setSpeed(rate);
    }

    function cycleSpeed(){
      const cur = Number(els.audio.playbackRate || 1);
      // Cycle through: 1.25, 1.5, 1.75, 2, 2.5 (skip 1 on cycle)
      const cycle = [1.25, 1.5, 1.75, 2, 2.5];
      const idx = cycle.indexOf(cur);
      const next = (idx === -1) ? cycle[0] : cycle[(idx + 1) % cycle.length];
      setSpeed(next);
    }

    function setPlayingUI(isPlaying){
      // Swap play/pause icon
      els.playIcon.innerHTML = isPlaying
        ? '<path d="M7 6h3v12H7zM14 6h3v12h-3z" fill="currentColor"/>'
        : '<path d="M9 7.5v9l8-4.5-8-4.5z" fill="currentColor"/>';
    }

    function persistTime(){
      if (!currentId) return;
      localStorage.setItem(LS.lastId, currentId);
      localStorage.setItem(LS.lastTime, String(els.audio.currentTime || 0));
    }

    function selectEpisode(id, opts = { autoplay: true, restoreTime: false }){
      const ep = episodes.find(e => String(e.id) === String(id)) || null;
      if (!ep) return;

      currentId = String(ep.id);
      els.nowTitle.textContent = safeTitle(ep);

      // small state chip (no system)
      const t = Array.isArray(ep.tags) && ep.tags.length ? ep.tags[0] : "Playing";
      els.nowTag.textContent = t;

      els.audio.src = ep.src || ep.url || "";
      els.audio.load();

      // Restore time (if requested)
      if (opts.restoreTime){
        const saved = Number(localStorage.getItem(LS.lastTime) || "0");
        if (isFinite(saved) && saved > 0){
          // Wait for metadata then set currentTime
          els.audio.addEventListener("loadedmetadata", function once(){
            els.audio.removeEventListener("loadedmetadata", once);
            els.audio.currentTime = Math.min(saved, Math.max(0, (els.audio.duration || saved)));
          });
        }
      } else {
        localStorage.setItem(LS.lastTime, "0");
      }

      localStorage.setItem(LS.lastId, currentId);

      if (opts.autoplay){
        els.audio.play().catch(() => {});
      }
    }

    function renderList(filter=""){
      const term = filter.trim().toLowerCase();
      const filtered = episodes.filter(ep => {
        const blob = JSON.stringify(ep).toLowerCase();
        return blob.includes(term);
      });

      els.episodeList.innerHTML = "";
      if (!filtered.length){
        const empty = document.createElement("div");
        empty.style.padding = "14px";
        empty.style.color = "var(--muted)";
        empty.style.fontSize = "13px";
        empty.textContent = "No matches.";
        els.episodeList.appendChild(empty);
        return;
      }

      filtered.forEach(ep => {
        const row = document.createElement("div");
        row.className = "rowitem";

        const left = document.createElement("div");
        left.className = "rowtext";

        const title = document.createElement("div");
        title.className = "rowtitle";
        title.textContent = safeTitle(ep); // shows epi + title only

        const meta = document.createElement("div");
        meta.className = "rowmeta";
        // keep meta minimal (no system) - show tags or duration if you have it
        const tag = (Array.isArray(ep.tags) && ep.tags.length) ? ep.tags.join(" • ") : "";
        meta.textContent = tag || " ";

        left.appendChild(title);
        left.appendChild(meta);

        const badge = document.createElement("div");
        badge.className = "badge";
        badge.textContent = (String(ep.id) === String(currentId)) ? "Now" : "Tap";

        row.appendChild(left);
        row.appendChild(badge);

        row.addEventListener("click", () => {
          selectEpisode(ep.id, { autoplay: true, restoreTime: false });
          closeDrawer();
        });

        els.episodeList.appendChild(row);
      });
    }

    async function init(){
      // Theme
      setTheme(getTheme());

      // Load episodes
      try{
        const res = await fetch(EP_URL, { cache: "no-store" });
        episodes = await res.json();
        if (!Array.isArray(episodes)) episodes = [];
      } catch(e){
        episodes = [];
      }

      // Render list
      renderList("");

      // Load saved speed
      loadSavedSpeed();

      // Restore last played episode & position
      const savedId = localStorage.getItem(LS.lastId);
      const savedTime = Number(localStorage.getItem(LS.lastTime) || "0");
      if (savedId && episodes.some(e => String(e.id) === String(savedId))){
        // restore time only if > 0
        selectEpisode(savedId, { autoplay: false, restoreTime: (isFinite(savedTime) && savedTime > 0) });
      } else if (episodes[0]?.id != null){
        // pick first as default (no autoplay)
        selectEpisode(episodes[0].id, { autoplay: false, restoreTime: false });
      }

      // Update "duration" when ready
      els.audio.addEventListener("loadedmetadata", () => {
        els.tDur.textContent = fmtTime(els.audio.duration || 0);
      });

      // Progress updates
      els.audio.addEventListener("timeupdate", () => {
        if (!seeking){
          const dur = els.audio.duration || 0;
          const cur = els.audio.currentTime || 0;
          els.seek.value = dur ? Math.round((cur / dur) * 1000) : 0;
          els.tCur.textContent = fmtTime(cur);
          els.tDur.textContent = fmtTime(dur);
        }
        // persist occasionally
        if (currentId) persistTime();
      });

      els.audio.addEventListener("play", () => setPlayingUI(true));
      els.audio.addEventListener("pause", () => setPlayingUI(false));
      els.audio.addEventListener("ended", () => setPlayingUI(false));

      // Seek handling
      els.seek.addEventListener("input", () => { seeking = true; });
      els.seek.addEventListener("change", () => {
        const dur = els.audio.duration || 0;
        const pct = Number(els.seek.value) / 1000;
        if (dur && isFinite(dur)){
          els.audio.currentTime = Math.max(0, Math.min(dur, dur * pct));
        }
        seeking = false;
      });

      // Controls
      els.playBtn.addEventListener("click", async () => {
        if (!els.audio.src) return;
        if (els.audio.paused) {
          try { await els.audio.play(); } catch(e){}
        } else {
          els.audio.pause();
        }
      });

      els.back15.addEventListener("click", () => {
        els.audio.currentTime = Math.max(0, (els.audio.currentTime || 0) - 15);
      });
      els.fwd30.addEventListener("click", () => {
        const dur = els.audio.duration || Infinity;
        els.audio.currentTime = Math.min(dur, (els.audio.currentTime || 0) + 30);
      });

      // Drawer (list)
      els.listBtn.addEventListener("click", openDrawer);
      els.drawerClose.addEventListener("click", closeDrawer);
      els.drawerBackdrop.addEventListener("click", closeDrawer);

      // Search
      els.search.addEventListener("input", () => renderList(els.search.value));
      els.clearSearch.addEventListener("click", () => {
        els.search.value = "";
        renderList("");
      });

      // Theme toggle (icon-only)
      els.themeBtn.addEventListener("click", () => {
        const cur = document.documentElement.getAttribute("data-theme") || "light";
        setTheme(cur === "light" ? "dark" : "light");
      });

      // About
      els.aboutBtn.addEventListener("click", openAbout);
      els.aboutClose.addEventListener("click", closeAbout);
      els.aboutBackdrop.addEventListener("click", closeAbout);

      // Speed controls
      els.speedBtn.addEventListener("click", () => {
        cycleSpeed();
      });
      els.speedResetBtn.addEventListener("click", () => {
        setSpeed(1);
      });

      // Keep list badge updated on select changes
      const rerenderOnSelect = () => renderList(els.search.value);
      els.audio.addEventListener("loadeddata", rerenderOnSelect);
    }

    init();
  </script>
</body>
</html>
